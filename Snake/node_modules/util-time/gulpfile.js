const gulp = require("gulp"),
      fs = require('fs'),
      ts = require("gulp-typescript"),
      uglify = require('gulp-uglify'),
      rename = require("gulp-rename"),
      tsProject = ts.createProject("tsconfig.json");

gulp.task("nodejs", function () {
  return gulp.src('src/util-time.ts')
    .pipe(tsProject())
    .js
    .pipe(uglify())
    .pipe(rename('index.js'))
    .pipe(gulp.dest("."));
});

gulp.task("browser", ['nodejs'], function () {
  // Remove exports
  let sourceFile = fs.readFileSync('src/util-time.ts', { encoding: 'utf8' })
                     .replace(/export(\sdefault\s\{.*\};)?/gi, '');

  fs.writeFileSync('./src/util-time-client.ts', sourceFile);

  return gulp.src('src/util-time-client.ts')
    .pipe(tsProject())
    .js
    .pipe(rename('util-time.js'))
    .pipe(uglify())
    .pipe(gulp.dest("./dist"));
});

gulp.task('default', ['nodejs', 'browser']);
gulp.watch('./src/*', ['default']);