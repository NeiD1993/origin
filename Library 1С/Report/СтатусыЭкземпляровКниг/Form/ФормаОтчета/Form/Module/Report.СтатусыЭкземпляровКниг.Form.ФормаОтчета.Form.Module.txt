
&НаСервере
Функция ФормированиеОтчета()
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|   ДвижениеЭкземпляровКниг.ВидКниги КАК ВидКниги,
	|   ДвижениеЭкземпляровКниг.Сектор КАК Сектор,
	|   ДвижениеЭкземпляровКниг.Код КАК Код,
	|   ДвижениеЭкземпляровКниг.РегистрационныйНомер КАК РегистрационныйНомер,
	|   ДвижениеЭкземпляровКниг.Название КАК Название,
	|   ДвижениеЭкземпляровКниг.Автор КАК Автор,
	|   ДвижениеЭкземпляровКниг.Статус
    |ИЗ
	|   РегистрСведений.ДвижениеЭкземпляровКниг КАК ДвижениеЭкземпляровКниг
    |УПОРЯДОЧИТЬ ПО
	|   ВидКниги,
	|   Сектор,
	|   Код,
	|   РегистрационныйНомер,
	|   ДвижениеЭкземпляровКниг.Период УБЫВ"
	);
	Выборка =  Запрос.Выполнить().Выбрать();
	Итератор = 0;
	Пока Выборка.Следующий() Цикл
		Если (Итератор = 0) Тогда
			ТекущийРегистрационныйНомер = Выборка.РегистрационныйНомер;
			НоваяСтрока = Отчет.Книги.Вставить(Итератор);
			НоваяСтрока.Вид = Выборка.ВидКниги;
			НоваяСтрока.Сектор = Выборка.Сектор;
			НоваяСтрока.Код = Выборка.Код;
			НоваяСтрока.РегистрационныйНомер = Выборка.РегистрационныйНомер;
			НоваяСтрока.Название = Выборка.Название;
			НоваяСтрока.Автор = Выборка.Автор;
			НоваяСтрока.Статус = Выборка.Статус;
			Итератор = Итератор + 1;
		Иначе 
			Если (Выборка.РегистрационныйНомер <> ТекущийРегистрационныйНомер) Тогда
				ТекущийРегистрационныйНомер = Выборка.РегистрационныйНомер;
				НоваяСтрока = Отчет.Книги.Вставить(Итератор);
			    НоваяСтрока.Вид = Выборка.ВидКниги;
			    НоваяСтрока.Сектор = Выборка.Сектор;
			    НоваяСтрока.Код = Выборка.Код;
			    НоваяСтрока.РегистрационныйНомер = Выборка.РегистрационныйНомер;
			    НоваяСтрока.Название = Выборка.Название;
			    НоваяСтрока.Автор = Выборка.Автор;
			    НоваяСтрока.Статус = Выборка.Статус;
				Итератор = Итератор + 1;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	Возврат Итератор;
КонецФункции

&НаКлиенте
Процедура СформироватьОтчет()
	Если (Отчет.Книги.Количество() <> 0) Тогда
		Отчет.Книги.Очистить();
	КонецЕсли;
	КоличествоСтрок = ФормированиеОтчета();
	Если (КоличествоСтрок <> 0) Тогда
		Элементы.Книги.ТекущаяСтрока = 0;
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	НоваяКоманда = ЭтаФорма.Команды.Добавить("СформироватьОтчет");
	НоваяКоманда.Действие = "СформироватьОтчет";
	НоваяКоманда.Картинка = БиблиотекаКартинок.СформироватьОтчет;
	НовыйЭлемент = Элементы.Добавить("КомандаСформироватьОтчет", Тип("КнопкаФормы"), Элементы.КнигиКоманднаяПанель);
	НовыйЭлемент.КнопкаПоУмолчанию = Истина;
	НовыйЭлемент.ИмяКоманды = "СформироватьОтчет";
	НовыйЭлемент.Заголовок = "Сформировать";
	НовыйЭлемент.Отображение = ОтображениеКнопки.Текст;
КонецПроцедуры
